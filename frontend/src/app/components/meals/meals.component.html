<div class="meals-page">
  <div class="page-header">
    <div class="header-content">
      <h1>üçΩÔ∏è Meal Planner</h1>
      <p class="subtitle">Plan delicious meals for your family</p>
    </div>
    <button (click)="toggleMealForm()" class="btn-add-meal">
      {{ showMealForm() ? '‚úï Cancel' : '+ Add Meal' }}
    </button>
  </div>

  <!-- Quick Meal Form -->
  @if (showMealForm()) {
    <div class="meal-form-card watercolor-card">
      <h3>Add New Meal</h3>
      <form (ngSubmit)="createMeal()">
        <div class="form-row">
          <div class="form-group">
            <label for="name">Meal Name</label>
            <input
              type="text"
              id="name"
              [(ngModel)]="newMeal.name"
              name="name"
              required
              class="form-input"
              placeholder="e.g., Spaghetti Bolognese"
            />
          </div>

          <div class="form-group">
            <label>Meal Type</label>
            <div class="category-buttons">
              <button
                type="button"
                class="category-btn"
                [class.active]="newMeal.category === 'breakfast'"
                (click)="newMeal.category = 'breakfast'"
              >
                ‚òï<br>Breakfast
              </button>
              <button
                type="button"
                class="category-btn"
                [class.active]="newMeal.category === 'lunch'"
                (click)="newMeal.category = 'lunch'"
              >
                üç±<br>Lunch
              </button>
              <button
                type="button"
                class="category-btn"
                [class.active]="newMeal.category === 'dinner'"
                (click)="newMeal.category = 'dinner'"
              >
                üçΩÔ∏è<br>Dinner
              </button>
              <button
                type="button"
                class="category-btn"
                [class.active]="newMeal.category === 'snack'"
                (click)="newMeal.category = 'snack'"
              >
                üç™<br>Snack
              </button>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label for="imageUrl">Image URL (optional)</label>
          <div class="image-url-group">
            <input
              type="url"
              id="imageUrl"
              [(ngModel)]="newMeal.imageUrl"
              name="imageUrl"
              class="form-input"
              placeholder="https://example.com/meal-image.jpg"
            />
            @if (newMeal.imageUrl) {
              <button type="button" (click)="previewImage()" class="btn-preview">
                üëÅÔ∏è Preview
              </button>
            }
          </div>
          @if (showImagePreview() && newMeal.imageUrl) {
            <div class="image-preview">
              <img [src]="newMeal.imageUrl" alt="Meal preview" (error)="onImageError()" />
            </div>
          }
        </div>

        <div class="form-group">
          <label for="ingredients">Ingredients (optional)</label>
          <textarea
            id="ingredients"
            [(ngModel)]="newMeal.ingredients"
            name="ingredients"
            rows="2"
            class="form-input"
            placeholder="List ingredients..."
          ></textarea>
        </div>

        <div class="form-group">
          <label for="recipe">Recipe Notes (optional)</label>
          <textarea
            id="recipe"
            [(ngModel)]="newMeal.recipe"
            name="recipe"
            rows="3"
            class="form-input"
            placeholder="Cooking instructions..."
          ></textarea>
        </div>

        <div class="form-group checkbox-group">
          <label>
            <input type="checkbox" [(ngModel)]="newMeal.isFavorite" name="isFavorite" />
            ‚≠ê Mark as Favorite
          </label>
        </div>

        <button type="submit" class="btn-submit">Add Meal</button>
      </form>
    </div>
  }

  <!-- Search and Filters -->
  <div class="meal-controls">
    <div class="search-bar">
      <input
        type="text"
        [(ngModel)]="searchQuery"
        (input)="onSearchChange()"
        placeholder="üîç Search meals..."
        class="search-input"
      />
      @if (searchQuery()) {
        <button (click)="clearSearch()" class="btn-clear-search">‚úï</button>
      }
    </div>

    <div class="category-filters">
      <button
        (click)="filterByCategory('')"
        class="filter-btn"
        [class.active]="selectedCategory() === ''"
      >
        All
      </button>
      <button
        (click)="filterByCategory('breakfast')"
        class="filter-btn"
        [class.active]="selectedCategory() === 'breakfast'"
      >
        ‚òï Breakfast
      </button>
      <button
        (click)="filterByCategory('lunch')"
        class="filter-btn"
        [class.active]="selectedCategory() === 'lunch'"
      >
        üç± Lunch
      </button>
      <button
        (click)="filterByCategory('dinner')"
        class="filter-btn"
        [class.active]="selectedCategory() === 'dinner'"
      >
        üçΩÔ∏è Dinner
      </button>
      <button
        (click)="filterByCategory('snack')"
        class="filter-btn"
        [class.active]="selectedCategory() === 'snack'"
      >
        üç™ Snack
      </button>
    </div>
  </div>

  @if (loading()) {
    <div class="loading">Loading meals...</div>
  }

  <!-- Meals Grid -->
  @if (!loading()) {
    <div class="meals-grid">
      @for (meal of filteredMeals(); track meal.id) {
        <div class="meal-card watercolor-card">
          <div class="meal-image">
            @if (meal.imageUrl) {
              <img [src]="meal.imageUrl" [alt]="meal.name" (error)="setDefaultImage($event)" />
            } @else {
              <div class="meal-placeholder">
                <span class="meal-icon">{{ getMealIcon(meal.category) }}</span>
              </div>
            }
            @if (meal.isFavorite) {
              <span class="favorite-badge">‚≠ê</span>
            }
          </div>

          <div class="meal-content">
            <h3 class="meal-name">{{ meal.name }}</h3>
            <div class="meal-meta">
              <span class="meal-category">{{ getMealIcon(meal.category) }} {{ meal.category | titlecase }}</span>
            </div>

            <div class="meal-actions">
              <button (click)="editMeal(meal)" class="btn-icon" title="Edit">
                ‚úèÔ∏è Edit
              </button>
              <button (click)="deleteMeal(meal.id)" class="btn-icon btn-delete" title="Delete">
                üóëÔ∏è Delete
              </button>
            </div>
          </div>
        </div>
      } @empty {
        <div class="empty-state">
          <div class="empty-icon">üçΩÔ∏è</div>
          <h3>No meals found</h3>
          <p>{{ searchQuery() ? 'Try a different search term' : 'Add your first meal to get started!' }}</p>
        </div>
      }
    </div>

    <!-- Pagination -->
    @if (totalMeals() > pageSize) {
      <div class="pagination">
        <div class="pagination-info">
          Showing {{ paginationStart() }}-{{ paginationEnd() }} of {{ totalMeals() }} meals
        </div>
        <div class="pagination-controls">
          <button
            (click)="previousPage()"
            [disabled]="currentPage() === 0"
            class="btn-page"
          >
            ‚Üê Previous
          </button>
          @for (page of pageNumbers(); track page) {
            <button
              (click)="goToPage(page)"
              class="btn-page"
              [class.active]="page === currentPage()"
            >
              {{ page + 1 }}
            </button>
          }
          <button
            (click)="nextPage()"
            [disabled]="(currentPage() + 1) * pageSize >= totalMeals()"
            class="btn-page"
          >
            Next ‚Üí
          </button>
        </div>
      </div>
    }
  }

  <!-- Edit Modal -->
  @if (showEditModal() && editingMeal()) {
    <div class="modal-overlay" (click)="closeEditModal()">
      <div class="modal-content watercolor-card" (click)="$event.stopPropagation()">
        <h2>Edit Meal</h2>
        <form (ngSubmit)="saveEditedMeal()">
          <div class="form-group">
            <label for="editName">Meal Name</label>
            <input
              type="text"
              id="editName"
              [(ngModel)]="editingMeal()!.name"
              name="editName"
              class="form-input"
              required
            />
          </div>

          <div class="form-group">
            <label>Meal Type</label>
            <div class="category-buttons">
              <button
                type="button"
                class="category-btn"
                [class.active]="editingMeal()!.category === 'breakfast'"
                (click)="editingMeal()!.category = 'breakfast'"
              >
                ‚òï<br>Breakfast
              </button>
              <button
                type="button"
                class="category-btn"
                [class.active]="editingMeal()!.category === 'lunch'"
                (click)="editingMeal()!.category = 'lunch'"
              >
                üç±<br>Lunch
              </button>
              <button
                type="button"
                class="category-btn"
                [class.active]="editingMeal()!.category === 'dinner'"
                (click)="editingMeal()!.category = 'dinner'"
              >
                üçΩÔ∏è<br>Dinner
              </button>
              <button
                type="button"
                class="category-btn"
                [class.active]="editingMeal()!.category === 'snack'"
                (click)="editingMeal()!.category = 'snack'"
              >
                üç™<br>Snack
              </button>
            </div>
          </div>

          <div class="form-group">
            <label for="editImageUrl">Image URL</label>
            <input
              type="url"
              id="editImageUrl"
              [(ngModel)]="editingMeal()!.imageUrl"
              name="editImageUrl"
              class="form-input"
            />
          </div>

          <div class="form-group">
            <label for="editIngredients">Ingredients</label>
            <textarea
              id="editIngredients"
              [(ngModel)]="editingMeal()!.ingredients"
              name="editIngredients"
              rows="3"
              class="form-input"
            ></textarea>
          </div>

          <div class="form-group">
            <label for="editRecipe">Recipe Notes</label>
            <textarea
              id="editRecipe"
              [(ngModel)]="editingMeal()!.recipe"
              name="editRecipe"
              rows="4"
              class="form-input"
            ></textarea>
          </div>

          <div class="form-group checkbox-group">
            <label>
              <input type="checkbox" [(ngModel)]="editingMeal()!.isFavorite" name="editIsFavorite" />
              ‚≠ê Mark as Favorite
            </label>
          </div>

          <div class="modal-actions">
            <button type="submit" class="btn-submit">Save Changes</button>
            <button type="button" (click)="closeEditModal()" class="btn-cancel">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  }
</div>
